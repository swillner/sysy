#!/usr/bin/env bash
set -e

if ! which realpath >/dev/null 2>/dev/null
then
    echo "Could not find realpath executable" 1>&2
    sudo apt-get install coreutils
fi

if ! which diff >/dev/null 2>/dev/null
then
    echo "Could not find diff executable" 1>&2
    sudo apt-get install diffutils
fi

scriptpath=$(dirname "$(realpath "$0")")
confdir=$HOME/.sysy.d
sysydir=$(dirname "$scriptpath")
tagsfile=$confdir/tags
tagspath=$(realpath "$scriptpath/../tags")

# shellcheck source=/home/sven/sync/sysy/scripts/include.sh
source "$scriptpath/../scripts/include.sh"

command=$1
shift || true
case "$command" in

    bootstrap)
        mkdir -p "$confdir"
        ensure_link "$sysydir/bin" "$confdir/bin"
        touch "$confdir/tags"
        if ask_user "Edit tags now?" "y" && open_in_editor "$confdir/tags"
        then
            info "Invoking pre-bootstrap scripts..."
            while IFS= read -r tag
            do
                script=$tagspath/$tag/pre-bootstrap.sh
                [ -f "$script" ] && bash "$script"
            done < "$tagsfile"

            info "Syncing system configuration..."
            bash "$sysydir/bin/cosy" sync
            info "Bootstrapping packages..."
            bash "$sysydir/bin/pasy" bootstrap
            info "Syncing packages..."
            bash "$sysydir/bin/pasy" sync
            info "Syncing dotfiles..."
            bash "$sysydir/bin/dosy" sync

            info "Invoking post-bootstrap scripts..."
            while IFS= read -r tag
            do
                script=$tagspath/$tag/post-bootstrap.sh
                [ -f "$script" ] && bash "$script"
            done < "$tagsfile"
        else
            info "Please run $0 sync again after editing"
        fi
        ;;

    sync)
        info "Syncing system configuration..."
        bash "$sysydir/bin/cosy" sync
        info "Syncing packages..."
        bash "$sysydir/bin/pasy" sync
        info "Syncing dotfiles..."
        bash "$sysydir/bin/dosy" sync
        ;;

    *)
        cat <<EOF
sysy - system synchronization

Usage:

    $0 COMMAND [ARGUMENTS]

Commands:

    bootstrap                   bootstrap
    sync                        synchronize

EOF
        exit 1
        ;;

esac
