#!/usr/bin/env bash
set -e

[[ -n "$sysypip" ]] || sysypip=pip3
[[ -n "$sysypython" ]] || sysypython=pip3

command=$1
shift || true
case "$command" in

    bootstrap)
        if ! command -v "$sysypython" >/dev/null 2>/dev/null
        then
            info "Installing $sysypython..."
            sudo apt-get install "$sysypython"
        fi
        if ! command -v "$sysypip" >/dev/null 2>/dev/null
        then
            curl -s https://bootstrap.pypa.io/get-pip.py | "$sysypython" - --user
        fi
        ;;

    desc)
        echo
        ;;

    install)
        "$sysypip" install --progress-bar=pretty --user "$@"
        ;;

    sync)
        packages=$(printf '%s\n' "$@" \
                       | sed 's/^\(.*\)\.git$/\1/g' \
                       | sed 's/^git+[a-zA-Z0-9.:\/_\-]*\/\([^\/@]*\)\(@[0-9a-fA-F]*\)\?$/\1/g' \
                       | sed 's/[-_.]/-/g' \
                       | tr '[:upper:]' '[:lower:]' \
                       | sort \
                       | uniq)
        readarray -t missing < <(comm -23 \
                                      <(echo "$packages") \
                                      <("$sysypip" list \
                                            | cut -d' ' -f1 \
                                            | sed 's/[-_.]/-/g' \
                                            | tr '[:upper:]' '[:lower:]' \
                                            | sort) \
                                )
        [[ "${#missing[@]}" == 0 ]] || "$sysypip" install --progress-bar=pretty --user "${missing[@]}"
        ;;

    uninstall)
        "$sysypip" uninstall "$@"
        ;;

    update)
        "$sysypip" install --progress-bar=pretty --user --upgrade "$@"
        ;;

    *)
        echo "Module does not support this command" 1>&2
        exit 2
        ;;

esac
